[{"id":"1e4eb5a44a1620cb","type":"tab","label":"PyPi Info gather","disabled":false,"info":"","env":[]},{"id":"9b44709910d2226f","type":"function","z":"1e4eb5a44a1620cb","name":"Format MQTT topic/data","func":"const cmds = msg.payload;\n//Object.values(cmds).forEach( cmd => {\n//  msg.product = cmd;\n//  msg.payload = cmd;\n//  node.send(msg);\n//});\nObject.entries(cmds).forEach(entry => {\n  const [software, cmd] = entry;\n  msg.software = software;\n//  msg.payload = cmd;\n  msg.topic = 'pypi_info/command'+\"/\"+msg.software\n  node.send(msg);\n});\n\nreturn null;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":450,"y":460,"wires":[["b69654da7444c7db"]]},{"id":"33eb9afcc8ba3e04","type":"inject","z":"1e4eb5a44a1620cb","name":"all commands","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"{\"last_seen\":\"date +\\\"%Y-%m-%d %T\\\"\",\"grafana\":\"grafana -v\",\"hostname\":\"hostname\",\"influx\":\"influx -version\",\"ip\":\"hostname -I\",\"memory\":\"free\",\"model\":\"cat /proc/device-tree/model\",\"mosquitto\":\"mosquitto -h\",\"netatalk\":\"netatalk -v\",\"nginx\":\"nginx -v\",\"node-red\":\"node-red -?\",\"osrelease\":\"lsb_release -c\",\"php\":\"php -v\",\"python3\":\"python3 --version\",\"sqlite3\":\"sqlite3 -version\",\"temperature\":\"/opt/vc/bin/vcgencmd measure_temp\"}","payloadType":"json","x":150,"y":320,"wires":[["4f45a25a29245b18"]]},{"id":"daa97ffafd54b8ef","type":"debug","z":"1e4eb5a44a1620cb","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":470,"y":580,"wires":[]},{"id":"b69654da7444c7db","type":"mqtt out","z":"1e4eb5a44a1620cb","name":"","topic":"","qos":"","retain":"","respTopic":"","contentType":"","userProps":"","correl":"","expiry":"","broker":"fc280b0a645350ec","x":650,"y":460,"wires":[]},{"id":"14b8de23306cf4fe","type":"mqtt in","z":"1e4eb5a44a1620cb","name":"","topic":"pypi_info/results/#","qos":"2","datatype":"json","broker":"fc280b0a645350ec","nl":false,"rap":true,"rh":0,"inputs":0,"x":210,"y":520,"wires":[["cbbc9883d2469202"]]},{"id":"2f123efc89898631","type":"inject","z":"1e4eb5a44a1620cb","name":"hostname","props":[{"p":"payload"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"{\"hostname\": \"hostname\"}","payloadType":"json","x":620,"y":40,"wires":[["4f45a25a29245b18"]]},{"id":"7d054409ae222715","type":"inject","z":"1e4eb5a44a1620cb","name":"node-red","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"{\"node-red\":\"node-red -?\"}","payloadType":"json","x":280,"y":160,"wires":[["4f45a25a29245b18"]]},{"id":"5d29cd397c98f0b6","type":"inject","z":"1e4eb5a44a1620cb","name":"osrelease","props":[{"p":"payload"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"{\"osrelease\":\"lsb_release -c\"}","payloadType":"json","x":460,"y":160,"wires":[["4f45a25a29245b18"]]},{"id":"e389883102954946","type":"mqtt in","z":"1e4eb5a44a1620cb","name":"","topic":"pypi_info/command/#","qos":"2","datatype":"auto","broker":"fc280b0a645350ec","nl":false,"rap":true,"rh":0,"inputs":0,"x":800,"y":280,"wires":[["ed6ae45361e65fe9"]]},{"id":"ed6ae45361e65fe9","type":"debug","z":"1e4eb5a44a1620cb","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":750,"y":340,"wires":[]},{"id":"07f59c061a8e3af2","type":"inject","z":"1e4eb5a44a1620cb","name":"grafana","props":[{"p":"payload"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"{\"grafana\": \"grafana -v\"}","payloadType":"json","x":450,"y":40,"wires":[["4f45a25a29245b18"]]},{"id":"40ccd17e1adacc76","type":"inject","z":"1e4eb5a44a1620cb","name":"netatalk","props":[{"p":"payload"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"{\"netatalk\": \"netatalk -v\"}","payloadType":"json","x":810,"y":100,"wires":[["4f45a25a29245b18"]]},{"id":"300313b5131b5243","type":"inject","z":"1e4eb5a44a1620cb","name":"influx","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"{\"influx\": \"influx -version\"}","payloadType":"json","x":810,"y":40,"wires":[["4f45a25a29245b18"]]},{"id":"4d397650b37a6475","type":"inject","z":"1e4eb5a44a1620cb","name":"IP","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"{\"ip\": \"hostname -I\"}","payloadType":"json","x":990,"y":40,"wires":[["4f45a25a29245b18"]]},{"id":"0d622cfa9819e30a","type":"inject","z":"1e4eb5a44a1620cb","name":"Date","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"{\"last_seen\":\"date +\\\"%Y-%m-%d %T\\\"\"}","payloadType":"json","x":270,"y":40,"wires":[["4f45a25a29245b18"]]},{"id":"0402e71b7a23de23","type":"inject","z":"1e4eb5a44a1620cb","name":"temperature","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"{\"temperature\": \"/opt/vc/bin/vcgencmd measure_temp\"}","payloadType":"json","x":290,"y":220,"wires":[["4f45a25a29245b18"]]},{"id":"bd630615e1b7b25e","type":"inject","z":"1e4eb5a44a1620cb","name":"memory","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"{\"memory\": \"free\"}","payloadType":"json","x":280,"y":100,"wires":[["4f45a25a29245b18"]]},{"id":"35315e3ac7d5e1a1","type":"link in","z":"1e4eb5a44a1620cb","name":"Run Command","links":["4f45a25a29245b18"],"x":200,"y":460,"wires":[["9b44709910d2226f"]],"l":true},{"id":"4f45a25a29245b18","type":"link out","z":"1e4eb5a44a1620cb","name":"to Run Command","mode":"link","links":["35315e3ac7d5e1a1"],"x":510,"y":320,"wires":[],"l":true},{"id":"4484386030ece471","type":"inject","z":"1e4eb5a44a1620cb","name":"model","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"{\"model\":\"cat /proc/device-tree/model\"}","payloadType":"json","x":450,"y":100,"wires":[["4f45a25a29245b18"]]},{"id":"4f5f97013e3caa65","type":"inject","z":"1e4eb5a44a1620cb","name":"mosquitto","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"{\"mosquitto\": \"mosquitto -h\"}","payloadType":"json","x":640,"y":100,"wires":[["4f45a25a29245b18"]]},{"id":"3776328d84d702da","type":"inject","z":"1e4eb5a44a1620cb","name":"python3","props":[{"p":"payload"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"{\"python3\": \"python3 --version\"}","payloadType":"json","x":820,"y":160,"wires":[["4f45a25a29245b18"]]},{"id":"c7717aff27bd1246","type":"inject","z":"1e4eb5a44a1620cb","name":"nginx","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"{\"nginx\": \"nginx -v\"}","payloadType":"json","x":990,"y":100,"wires":[["4f45a25a29245b18"]]},{"id":"41080e77d6010a7e","type":"inject","z":"1e4eb5a44a1620cb","name":"php","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"{\"php\":\"php -v\"}","payloadType":"json","x":630,"y":160,"wires":[["4f45a25a29245b18"]]},{"id":"f491bacd03a7bd3a","type":"inject","z":"1e4eb5a44a1620cb","name":"sqlite3","props":[{"p":"payload"},{"p":"topic","vt":"str"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"{\"sqlite3\":\"sqlite3 -version\"}","payloadType":"json","x":990,"y":160,"wires":[["4f45a25a29245b18"]]},{"id":"bb59b70b06252661","type":"change","z":"1e4eb5a44a1620cb","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"payload.stdout","tot":"msg","dc":true}],"action":"","property":"","from":"","to":"","reg":false,"x":420,"y":740,"wires":[["e7e28c09eeb43b85","6fa3a0410f7da50b"]]},{"id":"e7e28c09eeb43b85","type":"debug","z":"1e4eb5a44a1620cb","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":610,"y":780,"wires":[]},{"id":"04a4db54ea8633b4","type":"change","z":"1e4eb5a44a1620cb","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"not installed","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":420,"y":660,"wires":[["d0914086df3c49fb","57b44054110f0ade"]]},{"id":"b0b9504a4786bce1","type":"switch","z":"1e4eb5a44a1620cb","name":"stdout empty?","property":"payload.stdout","propertyType":"msg","rules":[{"t":"empty"},{"t":"else"}],"checkall":"false","repair":false,"outputs":2,"x":200,"y":700,"wires":[["04a4db54ea8633b4"],["bb59b70b06252661"]]},{"id":"d0914086df3c49fb","type":"debug","z":"1e4eb5a44a1620cb","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":630,"y":600,"wires":[]},{"id":"cbbc9883d2469202","type":"change","z":"1e4eb5a44a1620cb","name":"","rules":[{"t":"set","p":"hostname","pt":"msg","to":"payload.hostname","tot":"msg"},{"t":"set","p":"command","pt":"msg","to":"payload.command","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":200,"y":640,"wires":[["b0b9504a4786bce1"]]},{"id":"6fa3a0410f7da50b","type":"function","z":"1e4eb5a44a1620cb","name":"Parse results","func":"// model to store in DB\nlet hostname = msg.hostname\nlet command = msg.command\nlet payload = msg.payload\nlet host = flow.get(hostname)||{}\n\n// format commands that have extra text in their responses\nswitch(command) {\n    case \"date\":\n        const d1 = new Date();\n        payload = d1.getTime();\n        break;\n\n    case \"hostname\":\n        payload = hostname;\n        break;\n\n    case \"influx\":\n        payload = payload.replace(/\\n/g,\" \");\n        payload = payload.split(\" \")[3];\n        break;\n\n    case \"ip\":\n        payload = payload.replace(/ \\n/g, '');\n        break;\n\n    case \"last_seen\":\n        payload = Date.parse(payload);\n        break;\n\n    case \"memory\":\n        let memory = {};\n        memory.mem = {};\n        memory.swap = {};\n        payload = payload.replace(/\\n/g,\" \");\n        payload = payload.replace(/  +/g, ' ');\n        payload = payload.split(\" \");\n//       node.warn(\"total=\"+parseInt(payload[8]))\n        memory.mem.total      = parseInt(payload[8]);\n        memory.mem.used       = parseInt(payload[9]);\n        memory.mem.free       = parseInt(payload[10]);\n        memory.mem.shared     = parseInt(payload[11]);\n        memory.mem.buff_cache = parseInt(payload[12]);\n        memory.mem.available  = parseInt(payload[13]);\n        memory.swap.total     = parseInt(payload[15]);\n        memory.swap.used      = parseInt(payload[16]);\n        memory.swap.free      = parseInt(payload[17]);\n        payload = memory;\n        break;\n\n    case \"mosquitto\":\n        payload = payload.replace(/\\n/g,\" \");\n        payload = payload.split(\" \")[2];\n        break;\n \n    case \"model\":\n        payload = payload.replace(\"Raspberry \",\"\");\n//        payload = payload.split(\" \")[2];\n        break;\n \n    case \"netatalk\": \n        payload = payload.replace(/\\n/g,\" \");\n        payload = payload.split(\" -\")[0];\n        payload = payload.replace('netatalk ', '');\n        break;\n\n    case \"node-red\": \n        payload = payload.replace(/\\n/g,\" \");\n        payload = payload.split(\" \")[1];\n        payload = payload.replace(\"v\",\"\");\n        break;\n\n    case \"osrelease\":\n        payload = payload.replace('Codename:', '');\n        payload = payload.trim();\n        break;\n \n    case \"php\":\n        payload = payload.replace(/\\n/g, '');\n        payload = payload.split(\" \")[1];\n        break;\n \n    case \"python3\":\n        payload = payload.replace(/\\n/g, '');\n        payload = payload.replace('Python ', '');\n        break;\n \n    case \"sqlite3\":\n        payload = payload.split(\" \")[0];\n        break;\n\n    case \"temperature\":\n        payload = payload.split(\"=\")[1];\n        payload = payload.replace(/\\n/g,\"\");\n        payload = payload.replace(\"'C\", \"\");\n        payload = parseFloat(payload)\n        break;\n\n    default:\n        break;\n}\nmsg.payload = payload\nhost[command] = payload;\nflow.set(hostname, host)\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":630,"y":720,"wires":[["11d31363046177ae"]]},{"id":"11d31363046177ae","type":"debug","z":"1e4eb5a44a1620cb","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","statusVal":"","statusType":"auto","x":790,"y":700,"wires":[]},{"id":"7081d446a02cc533","type":"switch","z":"1e4eb5a44a1620cb","name":"","property":"payload.hostname","propertyType":"msg","rules":[{"t":"eq","v":"superpi","vt":"str"}],"checkall":"true","repair":false,"outputs":1,"x":190,"y":580,"wires":[["cbbc9883d2469202","daa97ffafd54b8ef"]]},{"id":"57b44054110f0ade","type":"function","z":"1e4eb5a44a1620cb","name":"Parse results","func":"// model to store in DB\nlet hostname = msg.hostname\nlet command = msg.command\nlet payload = msg.payload\nlet host = flow.get(hostname)||{}\n\nmsg.payload = payload\nhost[command] = payload;\nflow.set(hostname, host)\nreturn msg;","outputs":1,"noerr":0,"initialize":"","finalize":"","libs":[],"x":630,"y":660,"wires":[[]]},{"id":"a946dca90a094f4b","type":"inject","z":"1e4eb5a44a1620cb","name":"wipe flow variables","props":[{"p":"payload"}],"repeat":"","crontab":"","once":false,"onceDelay":0.1,"topic":"","payload":"","payloadType":"date","x":900,"y":420,"wires":[["1547410b93a3ecdd"]]},{"id":"1547410b93a3ecdd","type":"change","z":"1e4eb5a44a1620cb","name":"","rules":[{"t":"delete","p":"mqttpizw","pt":"flow"},{"t":"delete","p":"yellowpi","pt":"flow"},{"t":"delete","p":"fastpi","pt":"flow"},{"t":"delete","p":"superpi","pt":"flow"},{"t":"delete","p":"testpi","pt":"flow"}],"action":"","property":"","from":"","to":"","reg":false,"x":890,"y":480,"wires":[[]]},{"id":"fc280b0a645350ec","type":"mqtt-broker","name":"","broker":"mqttpizw.local","port":"1883","clientid":"","autoConnect":true,"usetls":false,"protocolVersion":"4","keepalive":"60","cleansession":true,"birthTopic":"","birthQos":"0","birthRetain":"false","birthPayload":"","birthMsg":{},"closeTopic":"","closeQos":"0","closeRetain":"false","closePayload":"","closeMsg":{},"willTopic":"","willQos":"0","willRetain":"false","willPayload":"","willMsg":{},"sessionExpiry":""}]